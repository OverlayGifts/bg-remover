<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jewels-AI Studio (Pro)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        h1 { margin-bottom: 5px; color: #2c3e50; }
        p.subtitle { color: #7f8c8d; margin-bottom: 25px; font-size: 0.9rem; }
        
        /* Steps UI */
        .step-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .step-title { font-weight: bold; font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        .upload-btn {
            background-color: #ecf0f1; color: #2c3e50; border: 2px dashed #bdc3c7;
            padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; width: 100%; box-sizing: border-box; font-weight: bold; transition: all 0.3s;
        }
        .upload-btn:hover { border-color: #3498db; background-color: #eaf2f8; }
        #fileInput { display: none; }

        .controls { display: none; margin-top: 20px; }
        .control-group { margin-bottom: 15px; }
        label { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; margin-top: 5px; accent-color: #3498db; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px; border-radius: 6px; text-decoration: none; font-weight: bold; cursor: pointer; border: none; flex: 1; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; color: white; transition: 0.2s; }
        
        /* Button Colors */
        .btn-ai { background-color: #8e44ad; } /* Purple for AI */
        .btn-ai:hover { background-color: #732d91; }
        .btn-ai:disabled { background-color: #d2b4de; cursor: not-allowed; }
        
        .btn-share { background-color: #27ae60; }
        .btn-down { background-color: #2c3e50; }

        .rename-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        
        canvas { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; border: 1px solid #ddd; display: none; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAFElEQVQ4T2NTgIP/OPABRf//DQApldl5OHdCDAAAAABJRU5ErkJggg=='); }
        
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 10px; }
        .badge-comp { background-color: #d4edda; color: #155724; }
        .badge-orig { background-color: #f8d7da; color: #721c24; }

        .spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; border-top-color: #fff; animation: spin 1s infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>Jewels-AI Studio</h1>
    <p class="subtitle">Step 1: Compress &bull; Step 2: Remove Background</p>

    <div class="step-box">
        <span class="step-title">Step 1: Upload Image</span>
        <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
            ðŸ“‚ Click to Select Image
            <div style="font-weight: normal; font-size: 0.8rem; margin-top: 5px; color: #7f8c8d;">Auto-compresses to Web Size (1080px)</div>
        </div>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <canvas id="previewCanvas"></canvas>
    <div id="sizeInfo" style="margin: 10px 0; font-size: 0.85rem; display:none;"></div>

    <div class="controls" id="controlsArea">
        
        <div class="step-box" style="background: #f3e5f5; border-color: #e1bee7;">
            <span class="step-title" style="color: #8e44ad;">Step 2: AI Tools</span>
            <button id="bgBtn" class="btn btn-ai" style="width:100%" onclick="initAndRunAI()">
                <div id="spinner" class="spinner"></div> 
                <span id="bgBtnText">âœ¨ Remove Background (AI)</span>
            </button>
        </div>

        <div class="step-box">
            <span class="step-title">Step 3: Enhance Look</span>
            
            <div class="control-group">
                <label>Brightness <span id="val-bright">100%</span></label>
                <input type="range" id="brightness" min="50" max="150" value="100">
            </div>

            <div class="control-group">
                <label>Color Pop <span id="val-sat">100%</span></label>
                <input type="range" id="saturation" min="0" max="200" value="100">
            </div>

            <div class="control-group">
                <label>Final Quality <span id="val-qual">85%</span></label>
                <input type="range" id="quality" min="10" max="100" value="85">
            </div>
        </div>

        <div class="step-box">
            <span class="step-title">Step 4: Rename & Save</span>
            <input type="text" id="filename" class="rename-input" placeholder="Enter file name">
            
            <div class="btn-row">
                <button class="btn btn-share" onclick="shareImage()">ðŸ”— Share</button>
                <a id="downloadBtn" class="btn btn-down">â¬‡ Download</a>
            </div>
        </div>
    </div>
</div>

<script>
    // --- VARIABLES ---
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const controlsArea = document.getElementById('controlsArea');
    const bgBtn = document.getElementById('bgBtn');
    const bgBtnText = document.getElementById('bgBtnText');
    const spinner = document.getElementById('spinner');
    const filenameInput = document.getElementById('filename');
    const downloadBtn = document.getElementById('downloadBtn');
    const sizeInfo = document.getElementById('sizeInfo');

    const sBright = document.getElementById('brightness');
    const sSat = document.getElementById('saturation');
    const sQual = document.getElementById('quality');

    let currentImg = null;
    let originalFileSize = 0;
    let isTransparent = false;

    // --- 1. UPLOAD & COMPRESS ---
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            originalFileSize = file.size;
            
            // Set Name
            const name = file.name.split('.').slice(0, -1).join('.');
            filenameInput.value = name + "_web";

            const reader = new FileReader();
            reader.onload = (event) => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    // COMPRESS LOGIC: Max 1080px
                    const maxWidth = 1080;
                    let w = tempImg.width;
                    let h = tempImg.height;
                    
                    if (w > maxWidth) {
                        h = h * (maxWidth / w);
                        w = maxWidth;
                    }

                    // Resize on temp canvas
                    const oc = document.createElement('canvas');
                    oc.width = w; oc.height = h;
                    const octx = oc.getContext('2d');
                    octx.drawImage(tempImg, 0, 0, w, h);

                    // Set as current image
                    currentImg = new Image();
                    currentImg.onload = () => {
                        isTransparent = false;
                        canvas.style.display = 'block';
                        controlsArea.style.display = 'block';
                        sizeInfo.style.display = 'block';
                        
                        // Reset AI Button
                        bgBtn.disabled = false;
                        bgBtn.style.display = 'flex';
                        bgBtnText.innerText = "âœ¨ Remove Background (AI)";
                        
                        renderImage();
                    }
                    currentImg.src = oc.toDataURL('image/jpeg', 0.9);
                }
                tempImg.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // --- 2. DYNAMIC AI LOADER (Bypasses Script Blocking) ---
    let aiLoaded = false;

    async function initAndRunAI() {
        if (!currentImg) return;

        bgBtn.disabled = true;
        spinner.style.display = "block";

        // Check if library is loaded
        if (typeof imgly === 'undefined') {
            bgBtnText.innerText = "Downloading AI Tool...";
            try {
                // Try Main Server
                await loadScript("https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.4/dist/imgly-background-removal.min.js");
            } catch (e) {
                console.log("Main server blocked, trying backup...");
                try {
                    // Try Backup Server (Unpkg)
                    await loadScript("https://unpkg.com/@imgly/background-removal@1.0.4/dist/imgly-background-removal.min.js");
                } catch (e2) {
                    alert("âš ï¸ Network Blocked: Your internet is blocking the AI file.\n\nPlease connect to Mobile Hotspot and try again.");
                    resetBtn();
                    return;
                }
            }
        }

        // Library loaded, now run it
        bgBtnText.innerText = "Removing Background...";
        runRemoval();
    }

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
        });
    }

    async function runRemoval() {
        try {
            // Config to try fetching model from Unpkg (usually less blocked)
            const config = {
                publicPath: "https://unpkg.com/@imgly/background-removal-data@1.0.4/dist/"
            };

            const blob = await imgly.removeBackground(currentImg, config);
            const url = URL.createObjectURL(blob);
            
            const newImg = new Image();
            newImg.onload = () => {
                currentImg = newImg;
                isTransparent = true;
                bgBtn.style.display = 'none'; // Hide button on success
                renderImage();
            };
            newImg.src = url;

        } catch (error) {
            console.error(error);
            alert("Error: AI Model Blocked. \nTry switching to Mobile Data.");
            resetBtn();
        }
    }

    function resetBtn() {
        bgBtn.disabled = false;
        spinner.style.display = "none";
        bgBtnText.innerText = "âœ¨ Remove Background (AI)";
    }

    // --- 3. RENDER & SAVE ---
    [sBright, sSat, sQual].forEach(s => s.addEventListener('input', renderImage));
    filenameInput.addEventListener('input', updateLink);

    function renderImage() {
        // Updates labels
        document.getElementById('val-bright').innerText = sBright.value + "%";
        document.getElementById('val-sat').innerText = sSat.value + "%";
        document.getElementById('val-qual').innerText = sQual.value + "%";

        canvas.width = currentImg.width;
        canvas.height = currentImg.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Apply filters
        ctx.filter = `brightness(${sBright.value}%) saturate(${sSat.value}%)`;
        ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);
        
        updateLink();
    }

    function updateLink() {
        const type = isTransparent ? 'image/png' : 'image/jpeg';
        const qual = sQual.value / 100;
        const dataUrl = canvas.toDataURL(type, qual);

        let name = filenameInput.value || "image";
        let ext = isTransparent ? '.png' : '.jpg';
        if (!name.endsWith(ext)) name += ext;

        downloadBtn.href = dataUrl;
        downloadBtn.download = name;

        // Size Calc
        const head = 'data:image/jpeg;base64,';
        const bytes = Math.round((dataUrl.length - head.length) * 3/4);
        const kbs = (bytes / 1024).toFixed(1);
        const origKbs = (originalFileSize / 1024).toFixed(1);
        
        sizeInfo.innerHTML = `Original: <span class="status-badge badge-orig">${origKbs} KB</span> â†’ New: <span class="status-badge badge-comp">${kbs} KB</span>`;
    }

    async function shareImage() {
        if (!navigator.share) { alert("Sharing not supported on this device."); return; }
        const type = isTransparent ? 'image/png' : 'image/jpeg';
        canvas.toBlob(async (blob) => {
            let name = filenameInput.value + (isTransparent ? '.png' : '.jpg');
            const file = new File([blob], name, { type });
            try { await navigator.share({ files: [file], title: 'Jewels-AI' }); } catch(e) {}
        }, type, sQual.value / 100);
    }
</script>

</body>
</html>