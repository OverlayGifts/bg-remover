<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jewels-AI Studio (Razor Sharp)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        h1 { margin-bottom: 5px; color: #2c3e50; }
        p.subtitle { color: #7f8c8d; margin-bottom: 25px; font-size: 0.9rem; }
        
        .upload-box { border: 2px dashed #bdc3c7; padding: 30px; border-radius: 8px; background-color: #fafafa; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .upload-box:hover { border-color: #3498db; background-color: #f0f8ff; }
        #fileInput { display: none; }

        .controls { display: none; text-align: left; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .control-group { margin-bottom: 15px; }
        label { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; margin-top: 5px; accent-color: #3498db; }
        
        /* Sharp Removal Sliders */
        .remove-zone { background: #fff0f0; padding: 15px; border-radius: 8px; border: 1px solid #ffcccc; margin-bottom: 20px; }
        #bgThreshold { accent-color: #c0392b; } /* Dark Red for precision */
        #bgCrisp { accent-color: #2c3e50; } /* Dark Blue for sharp edge */

        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn { padding: 12px; border-radius: 6px; text-decoration: none; font-weight: bold; cursor: pointer; border: none; flex: 1; display: flex; justify-content: center; align-items: center; font-size: 0.9rem; }
        .btn-share { background-color: #27ae60; color: white; }
        .btn-down { background-color: #2c3e50; color: white; }
        
        .rename-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        
        canvas { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; border: 1px solid #ddd; display: none; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAFElEQVQ4T2NTgIP/OPABRf//DQApldl5OHdCDAAAAABJRU5ErkJggg=='); }
        
        .stats { margin-top: 15px; font-size: 0.85rem; color: #27ae60; font-weight: bold; background: #e8f8f5; padding: 10px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Jewels-AI Studio</h1>
    <p class="subtitle">Razor-Sharp Edge Mode (No Firewall Issues)</p>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <h3>Click to Upload Image</h3>
        <p style="margin:0; font-size:0.8rem; color:#888;">Auto-detects background for sharp cutouts</p>
    </div>
    <input type="file" id="fileInput" accept="image/*">

    <canvas id="previewCanvas"></canvas>

    <div class="controls" id="controlsArea">
        
        <div class="remove-zone">
            <div class="control-group">
                <label style="color: #c0392b;">1. Cutout Precision <span id="val-thresh">OFF</span></label>
                <input type="range" id="bgThreshold" min="0" max="100" value="0">
                <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #999;">Move Right until background is gone. Don't overdo it.</p>
            </div>
            
            <div class="control-group" style="margin-bottom: 0;">
                <label style="color: #2c3e50;">2. Edge Crispness <span id="val-crisp">Max Sharp</span></label>
                <input type="range" id="bgCrisp" min="0" max="10" value="1">
                <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #999;">Keep left for sharpest edge. Move right to smooth slightly.</p>
            </div>
        </div>

        <div class="control-group">
            <label>Brightness <span id="val-bright">100%</span></label>
            <input type="range" id="brightness" min="50" max="150" value="100">
        </div>

        <div class="control-group">
            <label>Color Pop <span id="val-sat">100%</span></label>
            <input type="range" id="saturation" min="0" max="200" value="100">
        </div>

        <div class="control-group">
            <label>Compression <span id="val-qual">85%</span></label>
            <input type="range" id="quality" min="10" max="100" value="85">
        </div>

        <div style="text-align: left; margin-top: 20px;">
            <label style="margin-bottom: 5px;">Filename:</label>
            <input type="text" id="filename" class="rename-input" placeholder="Enter file name">
        </div>

        <div class="stats" id="statsText"></div>

        <div class="btn-row">
            <button class="btn btn-share" onclick="shareImage()">ðŸ”— Share</button>
            <a id="downloadBtn" class="btn btn-down">â¬‡ Download</a>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const controlsArea = document.getElementById('controlsArea');
    const statsText = document.getElementById('statsText');
    const downloadBtn = document.getElementById('downloadBtn');
    const filenameInput = document.getElementById('filename');

    // Sliders
    const sThresh = document.getElementById('bgThreshold');
    const sCrisp = document.getElementById('bgCrisp');
    const sBright = document.getElementById('brightness');
    const sSat = document.getElementById('saturation');
    const sQual = document.getElementById('quality');

    let currentImg = null;
    let originalFileSize = 0;
    let isTransparent = false;
    let bgColor = { r: 255, g: 255, b: 255 };

    // 1. UPLOAD & DETECT BG
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            originalFileSize = file.size;
            const name = file.name.split('.').slice(0, -1).join('.');
            filenameInput.value = name + "_sharp";

            const reader = new FileReader();
            reader.onload = (event) => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const maxWidth = 1080;
                    let w = tempImg.width; let h = tempImg.height;
                    if (w > maxWidth) { h = h * (maxWidth / w); w = maxWidth; }

                    const oc = document.createElement('canvas');
                    oc.width = w; oc.height = h;
                    const octx = oc.getContext('2d');
                    octx.drawImage(tempImg, 0, 0, w, h);

                    const data = octx.getImageData(0, 0, w, h).data;
                    bgColor = { r: data[0], g: data[1], b: data[2] }; // Detect top-left pixel

                    currentImg = new Image();
                    currentImg.onload = () => {
                        sThresh.value = 0; sCrisp.value = 1; // Default to sharp
                        sBright.value = 100;
                        canvas.style.display = 'block';
                        controlsArea.style.display = 'block';
                        statsText.style.display = 'block';
                        renderImage();
                    }
                    currentImg.src = oc.toDataURL('image/jpeg', 0.9);
                }
                tempImg.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // 2. RENDER LOOP
    [sThresh, sCrisp, sBright, sSat, sQual].forEach(s => s.addEventListener('input', renderImage));
    filenameInput.addEventListener('input', updateLink);

    function renderImage() {
        document.getElementById('val-thresh').innerText = sThresh.value > 0 ? sThresh.value : "OFF";
        document.getElementById('val-crisp').innerText = sCrisp.value == 0 ? "Max Sharp" : sCrisp.value;
        document.getElementById('val-bright').innerText = sBright.value + "%";
        document.getElementById('val-sat').innerText = sSat.value + "%";
        document.getElementById('val-qual').innerText = sQual.value + "%";

        canvas.width = currentImg.width; canvas.height = currentImg.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.filter = `brightness(${sBright.value}%) saturate(${sSat.value}%)`;
        ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);
        
        if (sThresh.value > 0) {
            isTransparent = true;
            // Send normalized values to the sharp function
            sharpRemoveBackground(parseInt(sThresh.value), parseInt(sCrisp.value));
        } else {
            isTransparent = false;
        }
        updateLink();
    }

    // --- 3. NEW RAZOR-SHARP ALGORITHM ---
    function sharpRemoveBackground(threshold, crispness) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Threshold scales to color distance limit
        const limit = threshold * 4.5; 
        // Crispness defines a tiny transition zone (0 to 15px range)
        const featherRange = crispness * 1.5; 

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i]; const g = data[i + 1]; const b = data[i + 2];
            // Calculate color distance from detected background
            const dist = Math.sqrt((r-bgColor.r)**2 + (g-bgColor.g)**2 + (b-bgColor.b)**2);

            if (dist < limit) {
                // Inside threshold = CUT (Transparent)
                data[i + 3] = 0;
            } else if (dist < limit + featherRange) {
                // In the tiny "crispness" zone = Micro-smooth for anti-aliasing
                // This creates a sharp edge without being jagged
                const alpha = (dist - limit) / featherRange;
                data[i + 3] = Math.floor(alpha * 255);
            }
            // Outside zone = KEEP (Opaque)
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function updateLink() {
        const type = isTransparent ? 'image/png' : 'image/jpeg';
        const qual = sQual.value / 100;
        const dataUrl = canvas.toDataURL(type, qual);
        let name = filenameInput.value || "image";
        let ext = isTransparent ? '.png' : '.jpg';
        if (!name.endsWith(ext)) name += ext;
        downloadBtn.href = dataUrl; downloadBtn.download = name;
        const head = 'data:image/jpeg;base64,';
        const size = Math.round((dataUrl.length - head.length) * 3 / 4);
        statsText.innerHTML = `Original: ${(originalFileSize/1024).toFixed(1)} KB â†’ New: <b>${(size/1024).toFixed(1)} KB</b>`;
    }

    async function shareImage() {
        if (!navigator.share) { alert("Sharing not supported on this device."); return; }
        const type = isTransparent ? 'image/png' : 'image/jpeg';
        canvas.toBlob(async (blob) => {
            let name = filenameInput.value + (isTransparent ? '.png' : '.jpg');
            const file = new File([blob], name, { type });
            try { await navigator.share({ files: [file], title: 'Jewels-AI' }); } catch(e) {}
        }, type, sQual.value / 100);
    }
</script>

</body>
</html>